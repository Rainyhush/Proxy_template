mode: rule
allow-lan: true
#bind-address: "*"
ipv6: true
global-ua: clash.meta
log-level: info
mixed-port: 7890
unified-delay: true
tcp-concurrent: true
disable-keep-alive: false
keep-alive-interval: 30
interface-name: Meta
find-process-mode: strict
global-client-fingerprint: chrome
external-controller: 127.0.0.1:9000

geodata-mode: false
geodata-loader: standard
geo-auto-update: true
geo-update-interval: 24
geox-url:
  geoip: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat"
  geosite: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat"
  mmdb: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb"
  asn: "https://github.com/xishang0128/geoip/releases/download/latest/GeoLite2-ASN.mmdb"
  proxy: Proxy
profile:
  store-selected: true
  store-fake-ip: true

sniffer:
  enable: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]

dns:
  enable: true
  ipv6: true
  prefer-h3: true
  listen: 0.0.0.0:1053
  respect-rules: false
  use-hosts: true
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  default-nameserver:
    - 223.5.5.5
    - 223.6.6.6
    - tls://1.12.12.12
    - 119.29.29.29
  nameserver:
    - https://doh.pub/dns-query
    - https://dns.alidns.com/dns-query
  proxy-server-nameserver:
    - https://dns.alidns.com/dns-query
    - https://doh.pub/dns-query
  nameserver-policy:
    "rule-set:ChinaMax_Domain,private":
    - https://223.5.5.5/dns-query
    - https://223.6.6.6/dns-query
  fallback:
    - tcp://1.1.1.1
    - https://1.0.0.1/dns-query
    - https://1.1.1.1/dns-query
    - https://8.8.8.8/dns-query
  fallback-filter:
    geoip: true
    geoip-code: CN
    geosite:
      - gfw
    ipcidr:
      - 240.0.0.0/4
      - 0.0.0.0/32
      - 127.0.0.1/32
    domain:
      - '+.google.com'
      - '+.facebook.com'
      - '+.youtube.com'
tun:
  enable: true
  stack: mixed
  dns-hijack:
    - "any:53"
    - "tcp://any:53"
  auto-route: true
  auto-redirect: true
  strict-route: true
  auto-detect-interface: true

proxy-providers:
  provider1:
    url: "https://gist.githubusercontent.com/Rainyhush/d1503a87dddac696c9e22f8658eb878d/raw/Clash.Meta"
    type: http
    interval: 86400
    proxy: Proxy
    health-check: 
      enable: true
      interval: 1800
      url: "https://www.gstatic.com/generate_204"
# 负载均衡-散列
lb-c: &lb-c
    type: load-balance
    url: 'https://www.gstatic.com/generate_204'
    interval: 300
    lazy: true
    strategy: consistent-hashing
# 负载均衡-轮询
lb-r: &lb-r
    type: load-balance
    url: 'https://www.gstatic.com/generate_204'
    interval: 300
    lazy: true
    strategy: round-robin

proxies:
  - name: "dns-out"
    type: dns
proxy-groups:
  - name: Proxy
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In
      
  - name: Google
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: OpenAI
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: YouTube
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: Telegram
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: Microsoft
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: Spotify
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: GitHub
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: China
    type: select
    proxies:
      - HongKong
      - Japan
      - Singapore
      - Taiwan
      - Korea
      - America
      - United Kingdom
      - ChinaR
      - Other
      - Load balancing
      - Built-In

  - name: HongKong
    type: select
    include-all: true
    filter: "(?i)(港|hk|HK|HongKong)"

  - name: Japan
    type: select
    include-all: true
    filter: "(?i)(日|jp|JP|Japan)"

  - name: Singapore
    type: select
    include-all: true
    filter: "(?i)(新|sg|SG|singapore)"

  - name: Taiwan
    type: select
    include-all: true
    filter: "(?i)(台|tw|TW|Taiwan)"
  - name: Taiwan-C
    <<: *lb-c
    include-all: true
    filter: "(?i)(台|tw|TW|Taiwan)"
  - name: Taiwan-R
    <<: *lb-r
    include-all: true
    filter: "(?i)(台|tw|TW|Taiwan)"


  - name: Korea
    type: select
    include-all: true
    filter: "(?i)(韩)"

  - name: America
    type: select
    include-all: true
    filter: "(?i)(美)"
  - name: America-C
    <<: *lb-c
    include-all: true
    filter: "(?i)(美)"
  - name: America-R
    <<: *lb-r
    include-all: true
    filter: "(?i)(美)"

  - name: United Kingdom
    type: select
    include-all: true
    filter: "(?i)(英)"

  - name: ChinaR
    type: select
    include-all: true
    filter: "(?i)(徐|镇|武|济)"

  - name: Other
    type: select
    include-all: true
    filter: "(?i)^(?!.*(?:港|台|日|新|韩|美|英|徐|镇|武|济|dns-out)).*"

  - name: Load balancing
    type: select
    proxies:
      - Taiwan-C
      - Taiwan-R
      - America-C
      - America-R

  - name: Built-In
    type: select
    proxies:
      - REJECT-DROP
      - REJECT
      - DIRECT

#  - name: 全部地区
#    type: url-test
#    include-all: true
#    exclude-filter: "dns-out" 
#    interval: 1800
#    tolerance: 50

rules:
  - RULE-SET,Advertising_Domain,Built-In
  - DST-PORT,53,dns-out
  - AND,(AND,(DST-PORT,443),(NETWORK,UDP)),(NOT,((GEOSITE,cn))),Built-In # 禁用quic(不包括国内)
  - RULE-SET,github,GitHub
  - RULE-SET,openai,OpenAI
  - RULE-SET,youtube,YouTube
  - RULE-SET,spotify,Spotify
  - RULE-SET,telegram,Telegram
  - RULE-SET,telegram_ip,Telegram
  - RULE-SET,microsoft,Microsoft
  - RULE-SET,google,Google
  - RULE-SET,google_ip,Google
  - RULE-SET,geolocation-!cn,Proxy
  - RULE-SET,ChinaMax_Domain,China
  - RULE-SET,ChinaMax_IP,China,no-resolve
  - RULE-SET,private,China,no-resolve
  - MATCH,Proxy

rule-anchor:
  ip: &ip
    type: http
    interval: 86400
    proxy: Proxy
    behavior: ipcidr
    format: yaml
  domain: &domain
    type: http
    interval: 86400
    proxy: Proxy
    behavior: domain
    format: yaml
  classical: &classical
    type: http
    interval: 86400
    proxy: Proxy
    behavior: classical
    format: yaml

rule-providers:
  Advertising_Domain:
    <<: *domain
    url: "https://github.com/blackmatrix7/ios_rule_script/raw/refs/heads/master/rule/Clash/Advertising/Advertising_Domain.yaml"
  ChinaMax_Domain:
    <<: *domain
    url: "https://github.com/blackmatrix7/ios_rule_script/raw/refs/heads/master/rule/Clash/ChinaMax/ChinaMax_Domain.yaml"
  private:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.yaml"
  google:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.yaml"
  github:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/github.yaml"
  openai:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/openai.yaml"
  spotify:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/spotify.yaml"
  youtube:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/youtube.yaml"
  telegram:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/telegram.yaml"
  microsoft:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/microsoft.yaml"
  geolocation-!cn:
    <<: *domain
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/geolocation-!cn.yaml"

  ChinaMax_IP:
    <<: *ip
    url: "https://github.com/blackmatrix7/ios_rule_script/raw/refs/heads/master/rule/Clash/ChinaMax/ChinaMax_IP.yaml"
  google_ip:
    <<: *ip
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/google.yaml"
  telegram_ip:
    <<: *ip
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.yaml"

